@page "/"
@model QuestionPapers.Pages.IndexModel
@{
    ViewData["Title"] = "CBSE Question Papers";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-attachment: fixed;
            color: #fff;
        }

            body::before, body::after {
                content: '';
                position: fixed;
                width: 400px;
                height: 400px;
                border-radius: 50%;
                filter: blur(120px);
                z-index: -1;
            }

            body::before {
                background: #ff6ec4;
                top: -100px;
                left: -100px;
            }

            body::after {
                background: #7873f5;
                bottom: -100px;
                right: -100px;
            }

        .glass-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

            .glass-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            }

        .form-select {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            border-radius: 12px;
        }

            .form-select option {
                color: #000;
            }

        .btn-modern {
            background: linear-gradient(45deg, #ff6ec4, #7873f5);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            transition: 0.3s ease;
        }

            .btn-modern:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            }

        .result-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(15px);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px;
            margin-bottom: 15px;
            transition: 0.3s ease;
        }

            .result-card:hover {
                transform: scale(1.02);
                background: rgba(255,255,255,0.25);
            }

        .badge {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 8px;
        }

        .pdf-modal .modal-dialog {
            max-width: 95vw;
            height: 90vh;
        }

        .pdf-modal .modal-content {
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            border-radius: 20px;
        }

        .pdf-modal #pdfContainer {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
        }

        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }

        /* Razor-safe keyframes */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Razor-safe media query */
        @@media (max-width:768px) {
            h1 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="text-center mb-5 fade-in">
            <h1>📚 CBSE Question Papers</h1>
            <p class="opacity-75">Search, Filter & View Previous Year Papers Instantly</p>
        </div>

        <div class="glass-card p-4 mb-4 fade-in">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Select Class</label>
                    <select id="classFilter" class="form-select">
                        <option value="">All Classes</option>
                        @if (Model.FileTree != null)
                        {
                            @foreach (var classFolder in Model.FileTree.Children.OrderBy(c => c.Name))
                            {
                                <option value="@classFolder.Name">Class @classFolder.Name</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">Select Year</label>
                    <select id="yearFilter" class="form-select" disabled>
                        <option value="">All Years</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">Select Subject</label>
                    <select id="subjectFilter" class="form-select" disabled>
                        <option value="">All Subjects</option>
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button onclick="filterFiles()" class="btn btn-modern w-100">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="fade-in">
            <div class="alert alert-light text-dark">Please select filters and click Search</div>
        </div>
    </div>

    <!-- PDF Modal -->
    <div class="modal fade pdf-modal" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white border-0">
                    <h5 class="modal-title" id="pdfFileName">PDF Viewer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="pdfContainer"></div>
                </div>
            </div>
        </div>
    </div>

    @if (Model.FileTree != null)
    {
        <div id="allData" style="display:none;">
            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FileTree))
        </div>
    }

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        var allData = null;

        document.addEventListener("DOMContentLoaded", function() {
            var dataElement = document.getElementById('allData');
            if (dataElement) {
                allData = JSON.parse(dataElement.innerText);
                loadYears();
            }

            document.getElementById('classFilter').addEventListener('change', function() {
                loadYears();
                loadSubjects();
            });

            document.getElementById('yearFilter').addEventListener('change', function() {
                loadSubjects();
            });
        });

        function loadYears() {
            var selectedClass = document.getElementById('classFilter').value;
            var yearSelect = document.getElementById('yearFilter');
            var subjectSelect = document.getElementById('subjectFilter');

            yearSelect.innerHTML = '<option value="">All Years</option>';
            subjectSelect.innerHTML = '<option value="">All Subjects</option>';

            if (!selectedClass) {
                yearSelect.disabled = true;
                subjectSelect.disabled = true;
                return;
            }

            var classFolder = allData.Children.find(c => c.Name === selectedClass);
            if (classFolder && classFolder.Children) {
                classFolder.Children.forEach(year => {
                    var option = document.createElement('option');
                    option.value = year.Name;
                    option.textContent = year.Name;
                    yearSelect.appendChild(option);
                });
                yearSelect.disabled = false;
            }
        }

        function loadSubjects() {
            var selectedClass = document.getElementById('classFilter').value;
            var selectedYear = document.getElementById('yearFilter').value;
            var subjectSelect = document.getElementById('subjectFilter');

            subjectSelect.innerHTML = '<option value="">All Subjects</option>';

            if (!selectedClass || !selectedYear) {
                subjectSelect.disabled = true;
                return;
            }

            var classFolder = allData.Children.find(c => c.Name === selectedClass);
            var yearFolder = classFolder.Children.find(y => y.Name === selectedYear);

            if (yearFolder && yearFolder.Children) {
                yearFolder.Children.forEach(subject => {
                    var option = document.createElement('option');
                    option.value = subject.Name;
                    option.textContent = subject.Name;
                    subjectSelect.appendChild(option);
                });
                subjectSelect.disabled = false;
            }
        }

        function openPdf(fileId, fileName) {
            var encodedId = btoa(fileId).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            var pdfUrl = '/Pdf/View/' + encodedId;

            document.getElementById('pdfFileName').innerText = fileName;

            var container = document.getElementById('pdfContainer');
            container.innerHTML = "";

            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                    pdf.getPage(pageNumber).then(function(page) {
                        var scale = 1.2;
                        var viewport = page.getViewport({ scale: scale });

                        var canvas = document.createElement('canvas');
                        var context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        container.appendChild(canvas);

                        page.render({ canvasContext: context, viewport: viewport });
                    });
                }
            });

            var modal = new bootstrap.Modal(document.getElementById('pdfModal'));
            modal.show();
        }

        function filterFiles() {
            var selectedClass = document.getElementById('classFilter').value;
            var selectedYear = document.getElementById('yearFilter').value;
            var selectedSubject = document.getElementById('subjectFilter').value;
            var container = document.getElementById('resultsContainer');

            if (!selectedClass) {
                container.innerHTML = '<div class="alert alert-warning text-dark">Please select a Class</div>';
                return;
            }

            var html = '';
            var count = 0;

            var classFolder = allData.Children.find(c => c.Name === selectedClass);

            if (classFolder && classFolder.Children) {
                classFolder.Children.forEach(yearFolder => {
                    if (selectedYear && yearFolder.Name !== selectedYear) return;

                    yearFolder.Children.forEach(subjectFolder => {
                        if (selectedSubject && subjectFolder.Name !== selectedSubject) return;

                        subjectFolder.Children.forEach(file => {
                            if (!file.IsDirectory) {
                                count++;
                                html += '<div class="result-card fade-in">';
                                html += '<div class="d-flex justify-content-between align-items-center flex-wrap">';
                                html += '<div class="fw-bold">' + file.Name + '</div>';
                                html += '<button onclick="openPdf(\'' + file.GoogleDriveId + '\', \'' + file.Name + '\')" class="btn btn-modern btn-sm">View</button>';
                                html += '</div></div>';
                            }
                        });
                    });
                });
            }

            container.innerHTML = count === 0
                ? '<div class="alert alert-warning text-dark">No files found.</div>'
                : html;
        }
    </script>
</body>
</html>